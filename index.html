<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‚¿í¬ë¡œ ì—¬í–‰ ì¼ì •</title>
  <style>
    :root{
      --bg1:#eaf6ff;
      --bg2:#ffffff;
      --card:#ffffffcc;
      --text:#1f2a44;
      --muted:#5f6f93;
      --line:#cfe3ff;
      --accent:#4f8cff;
      --accent2:#ff7aa5;
      --shadow: 0 10px 26px rgba(36, 75, 140, .16);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 700px at 15% 5%, #d7efff 0%, rgba(215,239,255,0) 60%),
        radial-gradient(900px 700px at 80% 10%, #ffe1ee 0%, rgba(255,225,238,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Cute falling snow */
    .snow{
      pointer-events:none;
      position:fixed; inset:0; z-index:0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.9) 0 2px, transparent 3px),
        radial-gradient(circle at 30% 70%, rgba(255,255,255,.9) 0 1.5px, transparent 3px),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,.9) 0 1.8px, transparent 3px),
        radial-gradient(circle at 90% 60%, rgba(255,255,255,.9) 0 1.2px, transparent 3px);
      background-size: 220px 220px, 260px 260px, 240px 240px, 280px 280px;
      animation: snowMove 14s linear infinite;
      opacity:.7;
    }
    @keyframes snowMove{
      from{ background-position: 0 0, 0 0, 0 0, 0 0; }
      to{ background-position: 0 520px, 0 620px, 0 560px, 0 680px; }
    }

    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(255,255,255,.85), rgba(255,255,255,.55));
      border-bottom: 1px solid rgba(207,227,255,.85);
    }
    .wrap{max-width:1080px; margin:0 auto; padding:0 14px; position:relative; z-index:2;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 0 14px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .sub{
      margin:0 0 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }

    /* NEW: Header character image */
    .heroChar{
      width:66px; height:66px;
      object-fit:contain;
      border-radius:16px;
      filter: drop-shadow(0 10px 12px rgba(79,140,255,.18));
      user-select:none;
    }

    main{padding:16px 0 42px;}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} header{position:static;} }

    .card{
      background: var(--card);
      border:1px solid rgba(207,227,255,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(207,227,255,.95);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.55));
    }
    .card .bd{padding:14px;}

    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    button{
      appearance:none;
      border:1px solid rgba(207,227,255,.95);
      background:#ffffffb3;
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      box-shadow: 0 8px 18px rgba(79,140,255,.08);
    }
    button:hover{border-color: rgba(79,140,255,.65)}
    button.primary{
      background: linear-gradient(180deg, rgba(79,140,255,.18), rgba(79,140,255,.10));
      border-color: rgba(79,140,255,.55);
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:700;}
    input, textarea, select{
      width:100%;
      padding:10px 11px;
      border-radius: 14px;
      border:1px solid rgba(207,227,255,.95);
      background: rgba(255,255,255,.92);
      color:var(--text);
      outline:none;
      font-size:13px;
      box-shadow: 0 10px 18px rgba(79,140,255,.06);
    }
    textarea{min-height:84px; resize:vertical; line-height:1.45}
    input:focus, textarea:focus, select:focus{border-color: rgba(79,140,255,.75)}
    .hint{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(207,227,255,.95);
      background: rgba(255,255,255,.7);
      color:var(--muted); font-size:12px; font-weight:800;
      box-shadow: 0 10px 18px rgba(79,140,255,.06);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 11px; border-radius:999px;
      border:1px solid rgba(79,140,255,.35);
      background: rgba(79,140,255,.12);
      color:#2b4ea3; font-size:12px; font-weight:900;
    }
    /* NEW: Day badge */
    .dayBadge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,122,165,.35);
      background: rgba(255,122,165,.12);
      color:#8a2a52;
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
    }

    .small{font-size:12px; color:var(--muted);}

    .list{display:flex; flex-direction:column; gap:10px;}
    .day{
      border:1px solid rgba(207,227,255,.95);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.68);
      box-shadow: 0 12px 20px rgba(79,140,255,.06);
    }
    .day .dayhd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(207,227,255,.95);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.55));
    }
    .daytitle{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .daytitle b{font-size:14px}
    .daytitle span{color:var(--muted); font-size:12px}

    .items{padding:10px 10px 12px; display:flex; flex-direction:column; gap:8px;}
    .item{
      border:1px solid rgba(207,227,255,.95);
      border-radius: 16px;
      padding:10px 10px;
      background: rgba(255,255,255,.85);
      display:grid;
      grid-template-columns: 24px 1fr auto;
      gap:10px;
      align-items:flex-start;
      box-shadow: 0 12px 18px rgba(79,140,255,.06);
    }
    .drag{
      width:24px; height:24px;
      border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px dashed rgba(95,111,147,.45);
      color:rgba(95,111,147,.75);
      cursor:grab;
      user-select:none;
      margin-top:2px;
      background: rgba(255,255,255,.85);
    }
    .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .time{font-weight:900; font-size:12px; color:#2b4ea3}
    .spot{font-weight:900; font-size:13px}
    .loc{font-size:12px; color:var(--muted)}
    .note{margin-top:6px; font-size:12px; color:rgba(31,42,68,.88); line-height:1.45; white-space:pre-wrap}
    .actions{display:flex; gap:6px;}
    .actions button{padding:8px 10px; border-radius:14px; font-size:12px}
    .actions button.danger{
      border-color: rgba(255,122,165,.55);
      background: rgba(255,122,165,.14);
    }

    .toast{
      position: fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(207,227,255,.95);
      border-radius: 999px;
      padding:10px 14px;
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:99;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px);}

    .hr{height:1px; background: rgba(207,227,255,.95); margin:12px 0;}
  </style>
</head>
<body>
  <div class="snow"></div>

  <header>
    <div class="wrap">
      <div class="top">
        <h1>
          <!-- ë³€ê²½ 1) ëˆˆì‚¬ëŒ ëŒ€ì‹  ìºë¦­í„° ì´ë¯¸ì§€ -->
          <img class="heroChar" src="character.png" alt="ìºë¦­í„°" />
          í–ë¬´ì™€ ì± ë¬´ì˜ ì‚¿í¬ë¡œ ì—¬í–‰â„ï¸
        </h1>
        <span class="pill" id="shareStatus">ê³µìœ  ë§í¬: ì•„ì§ ìƒì„± ì „</span>
      </div>
      <p class="sub">
        ì¼ì • ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ/ë“œë˜ê·¸ ì •ë ¬ ê°€ëŠ¥ Â· <b>ê³µìœ  ë§í¬ ë§Œë“¤ê¸°</b>ë¡œ ì¹œêµ¬ì—ê²Œ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ì„¸ìš”.<br/>
        íŒ: ìˆ˜ì •í•œ ì‚¬ëŒì´ ë‹¤ì‹œ â€œê³µìœ  ë§í¬ ë§Œë“¤ê¸°â€ ëˆŒëŸ¬ ìµœì‹  ë§í¬ë¥¼ ê³µìœ í•˜ë©´, ë‹¤ ê°™ì´ ê°™ì€ ì¼ì •ìœ¼ë¡œ ë§ì¶œ ìˆ˜ ìˆì–´ìš”.
      </p>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="hd">
          <div>
            <div class="badge">ğŸ“… ì¼ì •</div>
            <div class="small" style="margin-top:6px;">í•­ëª© ì™¼ìª½ í•¸ë“¤ì„ ë“œë˜ê·¸í•˜ë©´ ê°™ì€ ë‚ ì§œ ì•ˆì—ì„œ ìˆœì„œ ë³€ê²½!</div>
          </div>
          <div class="btns">
            <button class="primary" id="btnShare">ê³µìœ  ë§í¬ ë§Œë“¤ê¸°</button>
            <button id="btnCopy" disabled>ë§í¬ ë³µì‚¬</button>
          </div>
        </div>
        <div class="bd">
          <div id="planList" class="list"></div>
          <div class="hint" id="emptyHint" style="display:none;">
            ì•„ì§ ì¼ì •ì´ ì—†ì–´ìš”. ì˜¤ë¥¸ìª½ì—ì„œ ì¼ì •ì„ ì¶”ê°€í•´ë³´ì„¸ìš” â„ï¸
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd">
          <div>
            <div class="badge">â• ìƒˆ ì¼ì • ì¶”ê°€</div>
            <div class="small" style="margin-top:6px;">í•„ìš”í•˜ë©´ ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆì–´ìš” (ì˜ˆ: 16:00 â€“ 17:00)</div>
          </div>
          <div class="btns">
            <button class="primary" id="btnAdd">ì¶”ê°€</button>
            <button id="btnClear">ì…ë ¥ ì§€ìš°ê¸°</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>ë‚ ì§œ</label>
              <input id="fDate" type="date" />
            </div>
            <div>
              <label>ì¹´í…Œê³ ë¦¬</label>
              <select id="fTag">
                <option value="Food">ğŸ£ ìŒì‹</option>
                <option value="Cafe">â˜•ï¸ ì¹´í˜</option>
                <option value="Sight">ğŸ”ï¸ ê´€ê´‘</option>
                <option value="Shopping">ğŸ›ï¸ ì‡¼í•‘</option>
                <option value="Transit">ğŸš‡ êµí†µ</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>ì‹œì‘ ì‹œê°„ (ì„ íƒ)</label>
              <input id="fStart" type="time" />
            </div>
            <div>
              <label>ì¢…ë£Œ ì‹œê°„ (ì„ íƒ)</label>
              <input id="fEnd" type="time" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>ì¥ì†Œ/ìŠ¤íŒŸ ì´ë¦„</label>
            <input id="fTitle" placeholder="ì˜ˆ: ì˜¤íƒ€ë£¨ ìš´í•˜ ì•¼ê²½ ì‚°ì±…" />
          </div>

          <div style="margin-top:10px;">
            <label>ì£¼ì†Œ/ì§€ì—­ (ì„ íƒ)</label>
            <input id="fLocation" placeholder="ì˜ˆ: Susukino / Sapporo Station / Otaru Canal ..." />
          </div>

          <div style="margin-top:10px;">
            <label>ë©”ëª¨ (ì„ íƒ)</label>
            <textarea id="fNote" placeholder="ì˜ˆ: ì¶”ì²œ ë©”ë‰´, ì˜ˆì•½ í•„ìš” ì—¬ë¶€, ì‚¬ì§„ ìŠ¤íŒŸ, ì´ë™ íŒ ë“±"></textarea>
          </div>

          <div class="hr"></div>
          <div class="hint">
            âœ… ê³µìœ  ë°©ì‹: í˜„ì¬ ì¼ì •ì€ â€œê³µìœ  ë§í¬â€ì— ë‹´ê²¨ìš”. ì¹œêµ¬ê°€ ë§í¬ë¡œ ë“¤ì–´ì™€ ìˆ˜ì •í•œ ë’¤, ë‹¤ì‹œ ê³µìœ  ë§í¬ë¥¼ ë§Œë“¤ì–´ ë³´ë‚´ë©´ ìµœì‹  ë²„ì „ìœ¼ë¡œ ë§ì¶œ ìˆ˜ ìˆì–´ìš”.
          </div>
        </div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
  // =========================
  //  ì˜µì…˜ B: Polling Sync
  // =========================
  const SYNC_ENDPOINT = "https://script.google.com/macros/s/AKfycbzXxjneEodr_ZhTgMe-Rsp0Y2v51TCI_Eoh2cizc0nRIBxPEhjCJDB9mqo-OGVU4IY/exec"; // <- ì—¬ê¸°ì— Apps Script URL ë„£ê¸°
  const POLL_MS = 10000; // 10ì´ˆ
  const SAVE_DEBOUNCE_MS = 800;

  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1400);
  }
  function uid(){
    return Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
  }

  // ì¹´í…Œê³ ë¦¬
  const CAT = {
    Food: { label: "ìŒì‹", emoji: "ğŸ£" },
    Cafe: { label: "ì¹´í˜", emoji: "â˜•ï¸" },
    Sight: { label: "ê´€ê´‘", emoji: "ğŸ”ï¸" },
    Shopping: { label: "ì‡¼í•‘", emoji: "ğŸ›ï¸" },
    Transit: { label: "êµí†µ", emoji: "ğŸš‡" }
  };
  function catText(tag){
    const c = CAT[tag] || {label:"ê¸°íƒ€", emoji:"âœ¨"};
    return `${c.emoji} ${c.label}`;
  }

  // plan ëª¨ë¸
  let plan = { days: {} };

  // ì„œë²„ ë²„ì „/ì—…ë°ì´íŠ¸ ì‹œê°„
  let serverVersion = 1;
  let lastUpdatedAt = 0;

  // í˜„ì¬ ë°© ì½”ë“œ
  function getRoomFromHash(){
    const h = location.hash.startsWith("#") ? location.hash.slice(1) : "";
    const params = new URLSearchParams(h);
    return (params.get("room") || "").trim();
  }
  function setRoomToHash(room){
    const h = location.hash.startsWith("#") ? location.hash.slice(1) : "";
    const params = new URLSearchParams(h);
    params.set("room", room);
    location.hash = params.toString();
  }
  function ensureRoom(){
    let room = getRoomFromHash();
    if(!room){
      room = Math.random().toString(36).slice(2,8); // ê°„ë‹¨ ë°©ì½”ë“œ
      setRoomToHash(room);
    }
    return room;
  }

  // ì„œë²„ I/O
  async function fetchServerPlan(room){
    const url = `${SYNC_ENDPOINT}?room=${encodeURIComponent(room)}`;
    const r = await fetch(url, { method:"GET" });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || "fetch_failed");
    return data;
  }

  async function pushServerPlan(room){
    const url = `${SYNC_ENDPOINT}?room=${encodeURIComponent(room)}`;
    const payload = { plan, version: serverVersion };
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || "save_failed");
    // ì„œë²„ê°€ ë¶€ì—¬í•œ ìµœì‹  ë²„ì „ ë°˜ì˜
    serverVersion = data.version || (serverVersion + 1);
    lastUpdatedAt = data.updatedAt || Date.now();
    return data;
  }

  // polling
  let pollTimer = null;
  let isPushing = false;

  async function pollOnce(){
    const room = ensureRoom();
    try{
      const data = await fetchServerPlan(room);

      // ì„œë²„ê°€ ë” ìµœì‹ ì´ë©´ ë°˜ì˜
      const incomingVersion = data.version || 1;
      if(incomingVersion > serverVersion){
        plan = data.plan || { days:{} };
        serverVersion = incomingVersion;
        lastUpdatedAt = data.updatedAt || Date.now();
        render();
        toast("ì¹œêµ¬ì˜ ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í–ˆì–´ìš” â„ï¸");
      }
      setShareStatus(true);
    }catch(e){
      console.warn(e);
      // ë„¤íŠ¸ì›Œí¬ ì ê¹ ëŠê²¨ë„ UX ë§ì¹˜ì§€ ì•Šê¸°
    }
  }

  function startPolling(){
    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(pollOnce, POLL_MS);
  }

  // ì €ì¥ ë””ë°”ìš´ìŠ¤
  let saveTimer = null;
  function scheduleSave(){
    if(isPushing) return;
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      const room = ensureRoom();
      try{
        isPushing = true;
        await pushServerPlan(room);
        setShareStatus(true);
      }catch(e){
        console.warn(e);
        toast("ì €ì¥ì— ì‹¤íŒ¨í–ˆì–´ìš”(ë„¤íŠ¸ì›Œí¬ í™•ì¸)");
      } finally{
        isPushing = false;
      }
    }, SAVE_DEBOUNCE_MS);
  }

  // UI: ê³µìœ  ìƒíƒœ/ë§í¬
  function setShareStatus(enabled){
    const pill = $("shareStatus");
    pill.textContent = enabled ? "ê³µìœ (ë™ê¸°í™”) ON â„ï¸" : "ê³µìœ  ë§í¬: ì•„ì§ ìƒì„± ì „";
    $("btnCopy").disabled = !enabled;
  }
  function makeShareLink(){
    // ì˜µì…˜ Bì—ì„œëŠ” room ë§í¬ë§Œ ê³µìœ í•˜ë©´ ë¨
    ensureRoom();
    setShareStatus(true);
    toast("ì´ ë§í¬ë§Œ ê³µìœ í•˜ë©´ ê°™ì´ í¸ì§‘ë¼ìš”!");
  }
  async function copyLink(){
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      toast("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”!");
    }catch(e){
      prompt("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì•„ë˜ë¥¼ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”:", url);
    }
  }

  // ë Œë”ë§
  function dayKeysSorted(){ return Object.keys(plan.days).sort(); }

  function fmtDateLabel(yyyyMmDd){
    const d = new Date(yyyyMmDd + "T00:00:00");
    if(Number.isNaN(d.getTime())) return yyyyMmDd;
    const dow = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${mm}/${dd} (${dow})`;
  }

  function timeLabel(it){
    const s = (it.start || "").trim();
    const e = (it.end || "").trim();
    if(s && e) return `${s} â€“ ${e}`;
    if(s) return s;
    if(e) return `~ ${e}`;
    return "ì‹œê°„ ë¯¸ì •";
  }

  function sortItems(items){
    items.sort((a,b)=>{
      const at = (a.start || "99:99");
      const bt = (b.start || "99:99");
      const c = at.localeCompare(bt);
      if(c !== 0) return c;
      return (a.title || "").localeCompare(b.title || "");
    });
  }

  let editing = null;

  function render(){
    const list = $("planList");
    list.innerHTML = "";
    const keys = dayKeysSorted();
    $("emptyHint").style.display = (keys.length === 0) ? "block" : "none";

    keys.forEach((dateKey, i) => {
      const dayNumber = i + 1;

      const dayBox = document.createElement("div");
      dayBox.className = "day";

      const header = document.createElement("div");
      header.className = "dayhd";

      const left = document.createElement("div");
      left.className = "daytitle";

      const dayBadge = document.createElement("span");
      dayBadge.className = "dayBadge";
      dayBadge.textContent = `Day ${dayNumber}`;

      const b = document.createElement("b");
      b.textContent = fmtDateLabel(dateKey);

      const s = document.createElement("span");
      s.textContent = dateKey;

      left.appendChild(dayBadge);
      left.appendChild(b);
      left.appendChild(s);
      header.appendChild(left);

      const itemsWrap = document.createElement("div");
      itemsWrap.className = "items";
      itemsWrap.dataset.date = dateKey;

      const items = plan.days[dateKey] || [];
      sortItems(items);

      items.forEach((it) => {
        const itemEl = document.createElement("div");
        itemEl.className = "item";
        itemEl.draggable = true;
        itemEl.dataset.id = it.id;
        itemEl.dataset.date = dateKey;

        const drag = document.createElement("div");
        drag.className = "drag";
        drag.title = "ë“œë˜ê·¸í•´ì„œ ìˆœì„œ ë³€ê²½";
        drag.textContent = "â‹®â‹®";

        const body = document.createElement("div");

        const meta = document.createElement("div");
        meta.className = "meta";

        const time = document.createElement("span");
        time.className = "time";
        time.textContent = timeLabel(it);

        const tag = document.createElement("span");
        tag.className = "pill";
        tag.textContent = catText(it.tag);

        const spot = document.createElement("span");
        spot.className = "spot";
        spot.textContent = it.title || "(ì œëª© ì—†ìŒ)";

        meta.appendChild(time);
        meta.appendChild(tag);
        meta.appendChild(spot);

        const loc = document.createElement("div");
        loc.className = "loc";
        loc.textContent = it.location ? it.location : "";

        const note = document.createElement("div");
        note.className = "note";
        note.textContent = it.note ? it.note : "";

        body.appendChild(meta);
        if(it.location) body.appendChild(loc);
        if(it.note) body.appendChild(note);

        const actions = document.createElement("div");
        actions.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.onclick = () => {
          $("fDate").value = dateKey;
          $("fStart").value = it.start || "";
          $("fEnd").value = it.end || "";
          $("fTitle").value = it.title || "";
          $("fTag").value = it.tag || "Food";
          $("fLocation").value = it.location || "";
          $("fNote").value = it.note || "";
          editing = { date: dateKey, id: it.id };
          $("btnAdd").textContent = "ìˆ˜ì • ì €ì¥";
          toast("ìˆ˜ì • ëª¨ë“œ: ì˜¤ë¥¸ìª½ì—ì„œ ì €ì¥í•˜ì„¸ìš”");
        };

        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.onclick = () => {
          if(confirm("ì´ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?")){
            plan.days[dateKey] = (plan.days[dateKey] || []).filter(x => x.id !== it.id);
            if(plan.days[dateKey].length === 0) delete plan.days[dateKey];
            scheduleSave();
            render();
            toast("ì‚­ì œ ì™„ë£Œ");
          }
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        itemEl.appendChild(drag);
        itemEl.appendChild(body);
        itemEl.appendChild(actions);

        // Drag reorder
        itemEl.addEventListener("dragstart", (e)=>{
          e.dataTransfer.setData("text/plain", JSON.stringify({ date: dateKey, id: it.id }));
          e.dataTransfer.effectAllowed = "move";
          itemEl.style.opacity = "0.60";
        });
        itemEl.addEventListener("dragend", ()=> itemEl.style.opacity = "1");

        itemsWrap.appendChild(itemEl);
      });

      itemsWrap.addEventListener("dragover", (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });
      itemsWrap.addEventListener("drop", (e)=>{
        e.preventDefault();
        const payload = e.dataTransfer.getData("text/plain");
        if(!payload) return;
        let dragged;
        try{ dragged = JSON.parse(payload); } catch { return; }
        if(dragged.date !== dateKey) {
          toast("ê°™ì€ ë‚ ì§œ ì•ˆì—ì„œë§Œ ë“œë˜ê·¸ ì •ë ¬ì´ ê°€ëŠ¥í•´ìš”.");
          return;
        }
        const items = plan.days[dateKey] || [];
        const fromIdx = items.findIndex(x => x.id === dragged.id);
        if(fromIdx < 0) return;

        const target = e.target.closest(".item");
        if(!target) return;
        const toId = target.dataset.id;
        const toIdx = items.findIndex(x => x.id === toId);
        if(toIdx < 0 || toIdx === fromIdx) return;

        const [moved] = items.splice(fromIdx, 1);
        items.splice(toIdx, 0, moved);
        plan.days[dateKey] = items;

        scheduleSave();
        render();
        toast("ìˆœì„œë¥¼ ë³€ê²½í–ˆì–´ìš”.");
      });

      dayBox.appendChild(header);
      dayBox.appendChild(itemsWrap);
      list.appendChild(dayBox);
    });
  }

  function clearForm(){
    $("fStart").value = "";
    $("fEnd").value = "";
    $("fTitle").value = "";
    $("fTag").value = "Food";
    $("fLocation").value = "";
    $("fNote").value = "";
    editing = null;
    $("btnAdd").textContent = "ì¶”ê°€";
  }

  function upsertItem(){
    const date = $("fDate").value;
    const start = $("fStart").value.trim();
    const end = $("fEnd").value.trim();
    const title = $("fTitle").value.trim();
    const tag = $("fTag").value;
    const location = $("fLocation").value.trim();
    const note = $("fNote").value.trim();

    if(!date){ toast("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if(!title){ toast("ì¥ì†Œ/ìŠ¤íŒŸ ì´ë¦„ì€ ê¼­ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    if(start && end && end < start){ toast("ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ì–´ìš”."); return; }

    plan.days[date] = plan.days[date] || [];

    if(editing){
      const prevDate = editing.date;
      // ê¸°ì¡´ í•­ëª© ì°¾ì•„ì„œ ì œê±° í›„ ìƒˆë¡œ ë„£ëŠ” ë°©ì‹(ë‚ ì§œ ì´ë™ ì§€ì›)
      const prevItems = plan.days[prevDate] || [];
      const prevIdx = prevItems.findIndex(x => x.id === editing.id);
      let base = null;
      if(prevIdx >= 0){
        base = prevItems.splice(prevIdx, 1)[0];
        if(prevItems.length === 0) delete plan.days[prevDate];
      }
      const id = base?.id || uid();
      plan.days[date].push({ id, start, end, title, tag, location, note });
      toast("ìˆ˜ì • ì €ì¥ ì™„ë£Œ!");
    } else {
      plan.days[date].push({ id: uid(), start, end, title, tag, location, note });
      toast("ì¶”ê°€ ì™„ë£Œ!");
    }

    scheduleSave();
    clearForm();
    render();
  }

  // ë²„íŠ¼ ì—°ê²°
  $("btnAdd").addEventListener("click", upsertItem);
  $("btnClear").addEventListener("click", ()=>{ clearForm(); toast("ì…ë ¥ì„ ì§€ì› ì–´ìš”."); });

  // ì˜µì…˜ Bì—ì„œëŠ” "ê³µìœ  ë§í¬ ë§Œë“¤ê¸°" = room ìƒì„±/ê³ ì •
  $("btnShare").addEventListener("click", ()=>{
    ensureRoom();
    setShareStatus(true);
    toast("ì´ ë§í¬ë§Œ ê³µìœ í•˜ë©´ ê°™ì´ í¸ì§‘ë¼ìš”!");
  });
  $("btnCopy").addEventListener("click", copyLink);

  // ì´ˆê¸°í™”
  (async function init(){
    const room = ensureRoom();

    // ë‚ ì§œ ê¸°ë³¸ê°’
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    $("fDate").value = `${yyyy}-${mm}-${dd}`;

    // ì„œë²„ì—ì„œ ì²˜ìŒ ë¡œë“œ
    try{
      const data = await fetchServerPlan(room);
      plan = data.plan || { days:{} };
      serverVersion = data.version || 1;
      lastUpdatedAt = data.updatedAt || Date.now();
      setShareStatus(true);
      render();
      startPolling();
    }catch(e){
      console.warn(e);
      toast("ë™ê¸°í™” ì„œë²„ ì—°ê²° ì‹¤íŒ¨: URL í™•ì¸");
      // ê·¸ë˜ë„ UIëŠ” ë³´ì´ê²Œ
      render();
      startPolling();
    }
  })();
</script>
</body>
</html>
